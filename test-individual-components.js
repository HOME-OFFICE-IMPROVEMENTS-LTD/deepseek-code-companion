#!/usr/bin/env node

/**
 * Individual Component Testing Script
 * Tests each Phase 5 component in isolation
 */

const fs = require('fs');
const path = require('path');

// Mock VS Code environment
const mockVSCode = {
    workspace: {
        workspaceFolders: [{ uri: { fsPath: process.cwd() } }],
        getConfiguration: () => ({
            get: () => undefined
        }),
        createFileSystemWatcher: () => ({
            onDidChange: () => {},
            dispose: () => {}
        })
    },
    window: {
        createOutputChannel: (name) => ({
            appendLine: (text) => console.log(`[${name}] ${text}`),
            dispose: () => {}
        }),
        showInformationMessage: (msg) => console.log(`INFO: ${msg}`),
        showErrorMessage: (msg) => console.log(`ERROR: ${msg}`)
    },
    Uri: { file: (path) => ({ fsPath: path }) },
    commands: {
        registerCommand: (cmd, handler) => console.log(`Registered command: ${cmd}`)
    },
    ExtensionContext: class MockContext {
        constructor() {
            this.subscriptions = [];
            this.globalStorageUri = { fsPath: '/tmp/test-storage' };
            this.workspaceState = { 
                get: () => undefined, 
                update: () => Promise.resolve() 
            };
            this.globalState = { 
                get: () => undefined, 
                update: () => Promise.resolve() 
            };
            this.secrets = { 
                get: () => Promise.resolve(undefined), 
                store: () => Promise.resolve() 
            };
            this.extensionUri = { fsPath: '/tmp' };
            this.extensionPath = '/tmp';
            this.environmentVariableCollection = {};
            this.extensionMode = 1;
            this.logUri = { fsPath: '/tmp/logs' };
            this.storageUri = { fsPath: '/tmp/storage' };
        }
    }
};

// Mock require for VS Code module
const Module = require('module');
const originalRequire = Module.prototype.require;
Module.prototype.require = function(...args) {
    if (args[0] === 'vscode') {
        return mockVSCode;
    }
    return originalRequire.apply(this, args);
};

async function testSecurityScanner() {
    console.log('\nüîí Testing Security Scanner...');
    try {
        const { SecurityScanner } = require('./src/security/SecurityScanner');
        const mockModelManager = {
            sendMessage: async () => ({ content: 'Mock security analysis' })
        };
        
        const scanner = new SecurityScanner(mockModelManager);
        console.log('‚úÖ SecurityScanner instantiated successfully');
        
        // Test scanner methods
        if (typeof scanner.scanWorkspace === 'function') {
            console.log('‚úÖ scanWorkspace method exists');
        }
        if (typeof scanner.scanFile === 'function') {
            console.log('‚úÖ scanFile method exists');
        }
        if (typeof scanner.generateSecurityReport === 'function') {
            console.log('‚úÖ generateSecurityReport method exists');
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå SecurityScanner test failed:', error.message);
        return false;
    }
}

async function testDocumentationGenerator() {
    console.log('\nüìö Testing Documentation Generator...');
    try {
        const { DocumentationGenerator } = require('./src/docs/DocumentationGenerator');
        const mockModelManager = {
            sendMessage: async () => ({ content: 'Mock documentation' })
        };
        
        const generator = new DocumentationGenerator(mockModelManager);
        console.log('‚úÖ DocumentationGenerator instantiated successfully');
        
        // Test generator methods
        if (typeof generator.generateDocumentation === 'function') {
            console.log('‚úÖ generateDocumentation method exists');
        }
        if (typeof generator.generateAPIDocumentation === 'function') {
            console.log('‚úÖ generateAPIDocumentation method exists');
        }
        if (typeof generator.generateREADME === 'function') {
            console.log('‚úÖ generateREADME method exists');
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå DocumentationGenerator test failed:', error.message);
        return false;
    }
}

async function testTestGenerator() {
    console.log('\nüß™ Testing Test Generator...');
    try {
        const { TestGenerator } = require('./src/testing/TestGenerator');
        const mockModelManager = {
            sendMessage: async () => ({ content: 'Mock test code' })
        };
        
        const generator = new TestGenerator(mockModelManager);
        console.log('‚úÖ TestGenerator instantiated successfully');
        
        // Test generator methods
        if (typeof generator.generateTests === 'function') {
            console.log('‚úÖ generateTests method exists');
        }
        if (typeof generator.generateUnitTests === 'function') {
            console.log('‚úÖ generateUnitTests method exists');
        }
        if (typeof generator.generateIntegrationTests === 'function') {
            console.log('‚úÖ generateIntegrationTests method exists');
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå TestGenerator test failed:', error.message);
        return false;
    }
}

async function testMetricsDashboard() {
    console.log('\nüìä Testing Metrics Dashboard...');
    try {
        const { MetricsDashboard } = require('./src/metrics/MetricsDashboard');
        const mockModelManager = {
            sendMessage: async () => ({ content: 'Mock insights' })
        };
        const mockContext = new mockVSCode.ExtensionContext();
        
        const dashboard = new MetricsDashboard(mockContext, mockModelManager);
        console.log('‚úÖ MetricsDashboard instantiated successfully');
        
        // Test dashboard methods
        if (typeof dashboard.generateDashboard === 'function') {
            console.log('‚úÖ generateDashboard method exists');
        }
        if (typeof dashboard.calculateComplexity === 'function') {
            console.log('‚úÖ calculateComplexity method exists');
        }
        if (typeof dashboard.initializeMetricsTracking === 'function') {
            console.log('‚úÖ initializeMetricsTracking method exists');
        }
        
        // Test calculateComplexity functionality
        const complexity = dashboard.calculateComplexity('function test() { if (x > 0) { return true; } return false; }');
        if (typeof complexity === 'number' && complexity > 0) {
            console.log(`‚úÖ calculateComplexity returns valid number: ${complexity}`);
        }
        
        dashboard.dispose();
        console.log('‚úÖ MetricsDashboard disposed successfully');
        
        return true;
    } catch (error) {
        console.error('‚ùå MetricsDashboard test failed:', error.message);
        return false;
    }
}

async function testPhaseIntegrator() {
    console.log('\nüîß Testing Phase Integrator...');
    try {
        const { PhaseIntegrator } = require('./src/analysis/PhaseIntegrator');
        const mockModelManager = {
            sendMessage: async () => ({ content: 'Mock analysis' })
        };
        const mockContext = new mockVSCode.ExtensionContext();
        
        const integrator = new PhaseIntegrator(mockContext, mockModelManager);
        console.log('‚úÖ PhaseIntegrator instantiated successfully');
        
        // Test integrator methods
        if (typeof integrator.executePhase5Automation === 'function') {
            console.log('‚úÖ executePhase5Automation method exists');
        }
        if (typeof integrator.getAutomationCapabilities === 'function') {
            console.log('‚úÖ getAutomationCapabilities method exists');
        }
        if (typeof integrator.estimateAutomationPotential === 'function') {
            console.log('‚úÖ estimateAutomationPotential method exists');
        }
        
        integrator.dispose();
        console.log('‚úÖ PhaseIntegrator disposed successfully');
        
        return true;
    } catch (error) {
        console.error('‚ùå PhaseIntegrator test failed:', error.message);
        return false;
    }
}

async function testPhase5Integration() {
    console.log('\nüöÄ Testing Phase 5 Integration...');
    try {
        const { Phase5Integration } = require('./src/phase5/Phase5Integration');
        const mockModelManager = {
            sendMessage: async () => ({ content: 'Mock integration' })
        };
        const mockContext = new mockVSCode.ExtensionContext();
        
        const integration = new Phase5Integration(mockContext, mockModelManager);
        console.log('‚úÖ Phase5Integration instantiated successfully');
        
        // Test integration methods
        if (typeof integration.activate === 'function') {
            console.log('‚úÖ activate method exists');
        }
        if (typeof integration.deactivate === 'function') {
            console.log('‚úÖ deactivate method exists');
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå Phase5Integration test failed:', error.message);
        return false;
    }
}

async function runAllComponentTests() {
    console.log('üéØ Running Individual Component Tests');
    console.log('=====================================');
    
    const tests = [
        { name: 'SecurityScanner', test: testSecurityScanner },
        { name: 'DocumentationGenerator', test: testDocumentationGenerator },
        { name: 'TestGenerator', test: testTestGenerator },
        { name: 'MetricsDashboard', test: testMetricsDashboard },
        { name: 'PhaseIntegrator', test: testPhaseIntegrator },
        { name: 'Phase5Integration', test: testPhase5Integration }
    ];
    
    let passed = 0;
    let failed = 0;
    
    for (const { name, test } of tests) {
        const success = await test();
        if (success) {
            passed++;
            console.log(`‚úÖ ${name} test PASSED`);
        } else {
            failed++;
            console.log(`‚ùå ${name} test FAILED`);
        }
    }
    
    console.log('\nüìä Component Test Results:');
    console.log(`‚úÖ Passed: ${passed}`);
    console.log(`‚ùå Failed: ${failed}`);
    console.log(`üìà Success Rate: ${Math.round((passed / (passed + failed)) * 100)}%`);
    
    if (failed === 0) {
        console.log('\nüéâ ALL COMPONENT TESTS PASSED! üöÄ');
        return true;
    } else {
        console.log('\n‚ö†Ô∏è  Some component tests failed. Please review the errors above.');
        return false;
    }
}

// Run the tests
if (require.main === module) {
    runAllComponentTests().then(success => {
        process.exit(success ? 0 : 1);
    }).catch(error => {
        console.error('Test execution failed:', error);
        process.exit(1);
    });
}

module.exports = { runAllComponentTests };